<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Juegos Steam</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos Generales para el Fondo y Fuente */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a2e; /* Fondo oscuro similar al ejemplo */
            color: #e0e0e0; /* Texto claro */
            display: flex; /* Para el layout de sidebar y contenido */
            min-height: 100vh; /* Ocupa toda la altura de la ventana */
        }

        /* Contenedor Principal para el Dashboard */
        .dashboard-wrapper {
            display: flex;
            width: 100%;
        }

        /* Estilos del Sidebar (Menú Lateral) */
        .sidebar {
            width: 250px;
            background-color: #16213e; /* Fondo del sidebar más oscuro */
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .sidebar .logo {
            color: #e94560; /* Color distintivo para el logo */
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
        }

        .sidebar nav ul li {
            margin-bottom: 10px;
            width: 100%;
        }

        .sidebar nav ul li a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #e0e0e0;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .sidebar nav ul li a i {
            margin-right: 15px;
            font-size: 18px;
        }

        .sidebar nav ul li a:hover,
        .sidebar nav ul li a.active {
            background-color: #0f3460; /* Color al pasar el ratón o activo */
            color: #fff;
        }

        /* Estilos del Contenido Principal */
        .main-content {
            flex-grow: 1; /* Ocupa el espacio restante */
            padding: 30px;
            background-color: #1a1a2e; /* Mismo fondo que el body */
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #16213e; /* Fondo de la barra superior */
            padding: 15px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .header-bar .search-bar input {
            background-color: #0f3460;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            color: #e0e0e0;
            width: 300px;
        }

        .header-bar .user-info {
            display: flex;
            align-items: center;
        }

        .header-bar .user-info span {
            margin-right: 15px;
            color: #e0e0e0;
        }

        .header-bar .user-info .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e94560; /* Color de ejemplo para la foto */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        /* Estilos de las secciones de contenido */
        .content-section {
            background-color: #0f3460; /* Fondo de las tarjetas de contenido */
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .content-section h2 {
            color: #e94560; /* Títulos de sección */
            margin-bottom: 20px;
        }

        /* Estilos para formularios e inputs dentro de las secciones */
        .content-section input,
        .content-section textarea,
        .content-section select {
            background-color: #16213e;
            border: 1px solid #0f3460;
            padding: 10px 15px;
            border-radius: 5px;
            color: #e0e0e0;
            width: calc(100% - 32px);
            margin-bottom: 15px;
        }
        .content-section textarea {
            min-height: 80px;
            resize: vertical;
        }


        .content-section button {
            background-color: #e94560;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .content-section button:hover {
            background-color: #c9354b;
        }

        /* Mensajes de salida */
        #output {
            background-color: #16213e;
            border: 1px solid #e94560;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            margin-top: 20px;
            overflow: auto;
        }

        .error { color: #ff6347; font-weight: bold; }
        .success { color: #8aff8a; font-weight: bold; }
        .info { color: #87ceeb; font-weight: bold; }

        #apiStatus { padding: 10px; border-radius: 5px; font-weight: bold; margin-bottom: 15px; }
        #apiStatus.success { background-color: #0f3460; color: #8aff8a; border: 1px solid #8aff8a; }
        #apiStatus.error { background-color: #0f3460; color: #ff6347; border: 1px solid #ff6347; }
        
        .hidden { display: none; }

        .games-list-card {
            background-color: #1a1a2e; padding: 10px; border-radius: 5px; margin-bottom: 10px;
            border: 1px solid #0f3460; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
        }
        .games-list-card strong { color: #e94560; }
        .games-list-card .game-info-line { flex-basis: 100%; margin-bottom: 5px; }
        .games-list-card .game-actions { margin-top: 10px; flex-basis: 100%; text-align: right; }
        .games-list-card .game-actions button { margin-left: 10px; padding: 8px 12px; font-size: 0.9em; }

        #steamApiSection pre {
            background-color: #1a1a2e; padding: 15px; border-radius: 5px; margin-top: 15px;
            border: 1px solid #0f3460; overflow-x: auto;
        }

        #uploadedImagePreview {
            max-width: 100px; max-height: 100px; margin-top: 10px; border-radius: 5px;
            border: 1px solid #0f3460; display: none;
        }

        .game-details-display-card {
            background-color: #16213e; padding: 20px; border-radius: 10px; margin-top: 20px;
            display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .game-details-display-card img { max-width: 250px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .game-details-text-info { flex: 1; min-width: 280px; }
        .game-details-text-info h3 { color: #e94560; margin-top: 0; margin-bottom: 10px; font-size: 1.8em; }
        .game-details-text-info p { margin-bottom: 8px; color: #e0e0e0; }
        .game-details-text-info p strong { color: #b0b0b0; margin-right: 5px; }
        .game-details-description { margin-top: 15px; font-style: italic; color: #c0c0c0; max-height: 150px; overflow-y: auto; padding-right: 10px; border-top: 1px solid #0f3460; padding-top: 15px; }

        .review-card {
            background-color: #1a1a2e; padding: 15px; border-radius: 8px; margin-bottom: 15px;
            border: 1px solid #0f3460; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .review-card p { margin-bottom: 5px; color: #e0e0e0; }
        .review-card p strong { color: #e94560; }
        .review-card .review-image-preview { max-width: 150px; height: auto; border-radius: 5px; margin-top: 10px; border: 1px solid #0f3460; }
        .review-card .review-meta { font-size: 0.8em; color: #b0b0b0; margin-top: 10px; border-top: 1px dashed #0f3460; padding-top: 5px; }
        .review-actions { margin-top: 10px; text-align: right; }
        .review-actions button { font-size: 0.9em; padding: 5px 10px; margin-left: 8px; }

        .sub-section-card { background-color: #0f3460; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
        .sub-section-card h3 { color: #8aff8a; margin-bottom: 15px; }

        /* Estilos para el Canvas de la Gráfica */
        #playerCountChartContainer {
            width: 100%; max-width: 600px; height: 400px; margin: 20px auto;
            background-color: #1a1a2e; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #playerCountChart { background-color: #1a1a2e; }
        
        .analysis-results-card {
            background-color: #16213e; padding: 20px; border-radius: 10px; margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .analysis-results-card h3 { color: #e94560; margin-top: 0; margin-bottom: 15px; }

        @media (max-width: 768px) {
            .dashboard-wrapper { flex-direction: column; }
            .sidebar { width: 100%; height: auto; padding-bottom: 0; }
            .sidebar nav ul { display: flex; flex-wrap: wrap; justify-content: center; }
            .sidebar nav ul li { width: auto; margin: 5px; }
            .main-content { padding: 15px; }
            .header-bar { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <div class="sidebar">
            <div class="logo">Steam API</div>
            <nav>
                <ul>
                    <li><a href="#" id="nav-home" class="active"><i class="fas fa-home"></i> Inicio</a></li>
                    <li><a href="#" id="nav-games"><i class="fas fa-gamepad"></i> Juegos (DB)</a></li>
                    <li><a href="#" id="nav-create-game"><i class="fas fa-plus-circle"></i> Crear Juego (DB)</a></li>
                    <li><a href="#" id="nav-create-review"><i class="fas fa-comment-alt"></i> Crear Reseña</a></li>
                    <li><a href="#" id="nav-view-reviews"><i class="fas fa-comments"></i> Ver Reseñas</a></li>
                    <li><a href="#" id="nav-explore-steam"><i class="fab fa-steam-symbol"></i> Explorar Steam</a></li>
                    <li><a href="#" id="nav-steam-api"><i class="fab fa-steam"></i> Detalles Steam (Manual)</a></li>
                    <li><a href="#" id="nav-game-analysis"><i class="fas fa-chart-bar"></i> Análisis de Juegos</a></li>
                    <li><a href="#" id="nav-profile"><i class="fas fa-user"></i> Perfil</a></li>
                    <li><a href="#" id="nav-settings"><i class="fas fa-cog"></i> Configuración</a></li>
                    <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
                </ul>
            </nav>
        </div>

        <main class="main-content">
            <div class="header-bar">
                <div class="search-bar">
                    <input type="text" id="headerSearchInput" placeholder="Buscar en Steam y presiona Enter...">
                </div>
                <div class="user-info">
                    <span id="loggedInUserHeader">No autenticado</span>
                    <div class="profile-pic">?</div>
                </div>
            </div>

            <section id="authSection" class="content-section">
                <h2>Bienvenido</h2>
                <div style="display: flex; gap: 40px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 300px;">
                        <h3>Registrar nuevo usuario</h3>
                        <input type="text" id="regUsername" placeholder="Usuario">
                        <input type="email" id="regEmail" placeholder="Email">
                        <input type="password" id="regPassword" placeholder="Contraseña">
                        <button onclick="registerUser()">Registrar</button>
                        <p id="regMessage"></p>
                    </div>
                    <div style="flex: 1; min-width: 300px;">
                        <h3>Iniciar Sesión</h3>
                        <input type="text" id="loginUsername" placeholder="Usuario">
                        <input type="password" id="loginPassword" placeholder="Contraseña">
                        <button onclick="loginUser()">Iniciar Sesión</button>
                        <p id="loginMessage"></p>
                    </div>
                </div>
                <div id="apiStatus" style="margin-top: 20px;"></div>
            </section>
            
            <section id="gamesSection" class="content-section hidden">
                <h2>Juegos en tu Base de Datos</h2>
                <button onclick="getGames()">Actualizar Lista</button>
                <div id="gamesList" style="margin-top: 15px;"></div>
            </section>
            
            <section id="gameDetailSection" class="content-section hidden">
                <h2 id="dbGameName"></h2>
                <div id="dbGameDetailsCard" class="game-details-display-card"></div>
                <p id="dbGameDetailMessage"></p>
                <div class="sub-section-card">
                    <h3>Reseñas de este Juego</h3>
                    <div id="currentGameReviewsList"></div>
                </div>
                <div class="sub-section-card">
                    <h3>Crear Reseña para este Juego</h3>
                    <input type="hidden" id="reviewGameIdFromDetails">
                    <textarea id="reviewTextFromDetails" placeholder="Escribe tu reseña..."></textarea>
                    <input type="number" id="reviewRatingFromDetails" min="1" max="5" placeholder="Calificación (1-5)">
                    <label>Subir Imagen (Opcional): <input type="file" id="reviewImageFromDetails" accept="image/*"></label>
                    <button onclick="uploadAndSubmitReview()">Enviar Reseña</button>
                    <p id="createReviewMessageFromDetails"></p>
                </div>
            </section>

            <section id="createGameSection" class="content-section hidden">
                <h2>Crear Nuevo Juego (Manual)</h2>
                <input type="text" id="gameTitle" placeholder="Título"><input type="text" id="gameDev" placeholder="Desarrollador">
                <input type="text" id="gamePub" placeholder="Editor"><input type="text" id="gameGenres" placeholder="Géneros (separados por coma)">
                <input type="date" id="gameReleaseDate" placeholder="Fecha de Lanzamiento"><input type="number" id="gamePrice" step="0.01" placeholder="Precio">
                <input type="number" id="gameAppId" placeholder="Steam App ID"><button onclick="createGame()">Crear Juego</button>
                <p id="createGameMessage"></p>
            </section>
            
            <section id="createReviewSection" class="content-section hidden">
                <h2>Crear Nueva Reseña</h2>
                <input type="number" id="reviewGameId" placeholder="ID del Juego (de tu DB)">
                <textarea id="reviewText" placeholder="Texto de la reseña"></textarea>
                <input type="number" id="reviewRating" min="1" max="5" placeholder="Calificación (1-5)">
                <label>Subir Imagen (Opcional): <input type="file" id="reviewImage" accept="image/*"></label>
                <button onclick="submitStandaloneReview()">Enviar Reseña</button>
                <p id="createReviewMessage"></p>
            </section>

            <section id="viewReviewsSection" class="content-section hidden">
                <h2>Ver Todas las Reseñas</h2>
                <button onclick="getReviews(null, null, 'viewReviewsMessage', 'reviewsList')">Cargar Todas las Reseñas</button>
                <p id="viewReviewsMessage"></p>
                <div id="reviewsList"></div>
            </section>

            <section id="exploreSteamSection" class="content-section hidden">
                <h2>Explorar Juegos de Steam</h2>
                <p>Busca juegos en la tienda de Steam para importarlos a tu base de datos.</p>
                <input type="text" id="steamSearchQuery" placeholder="Escribe el nombre de un juego...">
                <button onclick="searchSteamStore()">Buscar</button>
                <p id="steamAppListMessage"></p>
                <div id="steamAppList"></div>
            </section>
            
            <section id="steamApiSection" class="content-section hidden">
                <h2>Buscar Detalles de Juego en Steam (Por App ID)</h2>
                <input type="number" id="steamAppIdInput" placeholder="Ej: 730 (CS:GO), 570 (Dota 2)">
                <button onclick="getSteamGameDetails()">Obtener Detalles de Steam</button>
                <p id="steamApiMessage"></p>
                <div id="steamApiFormattedOutput" class="game-details-display-card hidden"></div>
            </section>

            <section id="gameAnalysisSection" class="content-section hidden">
                <h2>Análisis de Juegos</h2>
                <p>Ingresa Steam App IDs (separados por coma) para comparar jugadores actuales.</p>
                <input type="text" id="analysisAppIds" placeholder="Ej: 730, 570, 271590">
                <button onclick="performGameAnalysis()">Realizar Análisis</button>
                <p id="analysisMessage"></p>
                <div id="playerCountChartContainer" class="hidden">
                    <canvas id="playerCountChart"></canvas>
                </div>
            </section>

            <section id="profileSection" class="content-section hidden">
                <h2>Mi Perfil</h2>
                <div class="profile-info">
                    <p><strong>Usuario:</strong> <span id="profileUsername"></span></p>
                    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                    <p><strong>ID de Usuario:</strong> <span id="profileUserId"></span></p>
                </div>
                <div class="sub-section-card">
                    <h3>Mis Reseñas</h3>
                    <div id="userReviewsList"></div>
                </div>
            </section>
            
            <section id="settingsSection" class="content-section hidden">
                <h2>Configuración</h2>
                <p>Esta sección está en construcción.</p>
            </section>

            <section class="content-section">
                <h2>Salida de la API (Debug)</h2>
                <pre id="output"></pre>
            </section>
        </main>
    </div>

    <script>
        const API_BASE_URL = "";
        let accessToken = localStorage.getItem('accessToken');
        let currentUsername = localStorage.getItem('currentUsername');
        let currentUserId = localStorage.getItem('currentUserId');
        let myChart = null;

        // --- Utility Functions ---
        function updateOutput(data, isError = false) {
            document.getElementById('output').textContent = JSON.stringify(data, null, 2);
            document.getElementById('output').className = isError ? 'error' : 'success';
        }

        function getAuthHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
            return headers;
        }

        function showSection(sectionId) {
            document.querySelectorAll('main > .content-section').forEach(s => s.classList.add('hidden'));
            const targetSection = document.getElementById(sectionId);
            if (targetSection) targetSection.classList.remove('hidden');

            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
            const navId = sectionId.replace('Section', '');
            const activeLink = document.getElementById(`nav-${navId}`) || document.getElementById('nav-home');
            if(activeLink) activeLink.classList.add('active');
        }

        async function handleApiResponse(response) {
            const text = await response.text();
            if (!response.ok) {
                try {
                    const jsonData = JSON.parse(text);
                    const detail = jsonData.detail || 'Error desconocido';
                    if (Array.isArray(detail)) return detail.map(err => `${err.loc.join('.')}: ${err.msg}`).join('; ');
                    return detail;
                } catch (e) { return text || response.statusText; }
            }
            try { return JSON.parse(text); } catch(e) { return text; }
        }

        function updateAuthUI() {
            const loggedInHeader = document.getElementById('loggedInUserHeader');
            const profilePic = loggedInHeader.nextElementSibling;
            const navLogout = document.getElementById('nav-logout');

            if (accessToken && currentUsername && currentUserId) {
                loggedInHeader.textContent = `Hola, ${currentUsername}`;
                profilePic.textContent = currentUsername.charAt(0).toUpperCase();
                navLogout.parentElement.style.display = 'block';
                showSection('gamesSection');
                getGames();
            } else {
                loggedInHeader.textContent = 'No autenticado';
                profilePic.textContent = '?';
                navLogout.parentElement.style.display = 'none';
                showSection('authSection');
            }
        }
        
        function logoutUser() {
            localStorage.clear();
            accessToken = null;
            currentUsername = null;
            currentUserId = null;
            updateAuthUI();
        }

        // --- Authentication ---
        async function registerUser() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const msgEl = document.getElementById('regMessage');
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/users/`, {
                    method: 'POST', headers: getAuthHeaders(),
                    body: JSON.stringify({ username, email, password })
                });
                const data = await handleApiResponse(response);
                if (!response.ok) throw new Error(data);
                msgEl.className = 'success';
                msgEl.textContent = `Usuario ${data.username} registrado.`;
                updateOutput(data);
            } catch (error) {
                msgEl.className = 'error';
                msgEl.textContent = `Error: ${error.message}`;
            }
        }

        async function loginUser() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const msgEl = document.getElementById('loginMessage');
            const formData = new URLSearchParams({username, password});
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/token`, {
                    method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData.toString()
                });
                const data = await handleApiResponse(response);
                if (!response.ok) throw new Error(data);
                accessToken = data.access_token;
                currentUsername = data.username;
                currentUserId = data.user_id;
                localStorage.setItem('accessToken', accessToken);
                localStorage.setItem('currentUsername', currentUsername);
                localStorage.setItem('currentUserId', currentUserId);
                updateAuthUI();
            } catch (error) {
                msgEl.className = 'error';
                msgEl.textContent = `Error: ${error.message}`;
                logoutUser();
            }
        }
        
        // --- Game Functions ---
        async function getGames() {
            const listEl = document.getElementById('gamesList');
            listEl.innerHTML = '<p class="info">Cargando...</p>';
            try {
                const games = await (await fetch(`${API_BASE_URL}/api/v1/games/`, { headers: getAuthHeaders() })).json();
                listEl.innerHTML = games.length ? games.map(game => `
                    <div class="games-list-card">
                        <span><strong>${game.title}</strong> (ID: ${game.id})</span>
                        <button onclick="viewGameDetailsFromDB(${game.id})">Ver Detalles</button>
                    </div>`).join('') : '<p>No hay juegos en la base de datos.</p>';
            } catch(error) { listEl.innerHTML = `<p class="error">Error: ${error.message}</p>`; }
        }

        async function createGame() {
            const msgEl = document.getElementById('createGameMessage');
            const gameData = {
                title: document.getElementById('gameTitle').value,
                developer: document.getElementById('gameDev').value,
                publisher: document.getElementById('gamePub').value,
                genres: document.getElementById('gameGenres').value,
                release_date: document.getElementById('gameReleaseDate').value,
                price: parseFloat(document.getElementById('gamePrice').value),
                steam_app_id: parseInt(document.getElementById('gameAppId').value)
            };
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/games/`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(gameData) });
                const data = await handleApiResponse(res);
                if (!res.ok) throw new Error(data);
                msgEl.className = 'success';
                msgEl.textContent = "Juego creado con éxito.";
            } catch (error) { msgEl.className = 'error'; msgEl.textContent = `Error: ${error.message}`; }
        }

        async function viewGameDetailsFromDB(gameId) {
            showSection('gameDetailSection');
            const nameEl = document.getElementById('dbGameName');
            const cardEl = document.getElementById('dbGameDetailsCard');
            nameEl.textContent = "Cargando...";
            cardEl.innerHTML = "";
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/games/${gameId}`, { headers: getAuthHeaders() });
                const game = await handleApiResponse(res);
                if (!res.ok) throw new Error(game);
                nameEl.textContent = game.title;
                cardEl.innerHTML = `
                    <p><strong>Desarrollador:</strong> ${game.developer || 'N/A'}</p>
                    <p><strong>Editor:</strong> ${game.publisher || 'N/A'}</p>
                    <p><strong>Géneros:</strong> ${game.genres || 'N/A'}</p>
                    <p><strong>Lanzamiento:</strong> ${game.release_date || 'N/A'}</p>
                `;
                document.getElementById('reviewGameIdFromDetails').value = game.id;
                await getReviews(game.id, null, 'dbGameDetailMessage', 'currentGameReviewsList');
            } catch (error) { nameEl.textContent = "Error"; cardEl.innerHTML = `<p class="error">${error.message}</p>`; }
        }

        // --- Review Functions ---
        async function getReviews(gameId, userId, msgElId, listElId) {
            const listEl = document.getElementById(listElId);
            listEl.innerHTML = `<p class="info">Cargando reseñas...</p>`;
            let query = new URLSearchParams();
            if (gameId) query.append('game_id', gameId);
            if (userId) query.append('user_id', userId);
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/reviews/?${query}`, { headers: getAuthHeaders() });
                const reviews = await handleApiResponse(res);
                if (!res.ok) throw new Error(reviews);
                listEl.innerHTML = reviews.length ? reviews.map(r => `
                    <div class="review-card" id="review-card-${r.id}">
                        <p>${'⭐'.repeat(r.rating || 0)}</p>
                        <p><strong>Reseña:</strong> ${r.review_text}</p>
                        ${r.image_filename ? `<img src="${API_BASE_URL}${r.image_filename}" class="review-image-preview">` : ''}
                        <p class="review-meta">Por: ${r.user.username} | Juego: ${r.game.title}</p>
                        ${r.user_id == currentUserId ? `<div class="review-actions"><button onclick="promptToEditReview(${r.id})">Editar</button><button onclick="deleteReview(${r.id})">Eliminar</button></div>` : ''}
                    </div>`).join('') : '<p>No se encontraron reseñas.</p>';
            } catch (error) { listEl.innerHTML = `<p class="error">Error: ${error.message}</p>`; }
        }

        async function uploadAndSubmitReview() {
             const msgEl = document.getElementById('createReviewMessageFromDetails');
             const gameId = document.getElementById('reviewGameIdFromDetails').value;
             const reviewText = document.getElementById('reviewTextFromDetails').value;
             const rating = document.getElementById('reviewRatingFromDetails').value;
             const imageFile = document.getElementById('reviewImageFromDetails').files[0];
             if (!gameId || !reviewText) { msgEl.className = 'error'; msgEl.textContent = "El texto es obligatorio."; return; }
             msgEl.className = 'info'; msgEl.textContent = 'Procesando...';
             try {
                let imageUrl = null;
                if (imageFile) {
                    const formData = new FormData();
                    formData.append('file', imageFile);
                    const imgRes = await fetch(`${API_BASE_URL}/api/v1/upload_image`, { method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}` }, body: formData });
                    const imgData = await handleApiResponse(imgRes);
                    if (!imgRes.ok) throw new Error(`Subida de imagen falló: ${imgData}`);
                    imageUrl = imgData.url;
                }
                const reviewData = { review_text: reviewText, rating: rating ? parseInt(rating) : null, image_filename: imageUrl };
                const revRes = await fetch(`${API_BASE_URL}/api/v1/reviews/?game_id=${gameId}`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(reviewData) });
                const newRev = await handleApiResponse(revRes);
                if (!revRes.ok) throw new Error(`Creación de reseña falló: ${newRev}`);
                msgEl.className = 'success'; msgEl.textContent = "Reseña creada.";
                await getReviews(gameId, null, 'dbGameDetailMessage', 'currentGameReviewsList');
             } catch (error) { msgEl.className = 'error'; msgEl.textContent = `Error: ${error.message}`; }
        }

        async function submitStandaloneReview() {
            alert("Esta función aún no está implementada. Por favor, crea reseñas desde la página de detalles de un juego.");
        }

        async function promptToEditReview(reviewId) {
             try {
                const res = await fetch(`${API_BASE_URL}/api/v1/reviews/${reviewId}`, { headers: getAuthHeaders() });
                const review = await handleApiResponse(res);
                if (!res.ok) throw new Error(review);
                const newText = prompt("Edita tu reseña:", review.review_text);
                if (newText && newText !== review.review_text) {
                    const reviewData = { ...review, review_text: newText };
                    const updateRes = await fetch(`${API_BASE_URL}/api/v1/reviews/${reviewId}`, { method: 'PUT', headers: getAuthHeaders(), body: JSON.stringify(reviewData) });
                    const updated = await handleApiResponse(updateRes);
                    if (!updateRes.ok) throw new Error(updated);
                    alert("Reseña actualizada.");
                    viewGameDetailsFromDB(updated.game.id);
                }
            } catch(error) { alert(`Error: ${error.message}`); }
        }

        async function deleteReview(reviewId) {
            if (confirm("¿Seguro que quieres eliminar esta reseña?")) {
                try {
                    const res = await fetch(`${API_BASE_URL}/api/v1/reviews/${reviewId}`, { method: 'DELETE', headers: getAuthHeaders() });
                    if (res.status !== 204) { const err = await handleApiResponse(res); throw new Error(err); }
                    alert("Reseña eliminada.");
                    document.getElementById(`review-card-${reviewId}`).remove();
                } catch(error) { alert(`Error: ${error.message}`); }
            }
        }
        
        // --- Steam API Functions ---
        async function searchSteamStore() {
            const listEl = document.getElementById('steamAppList');
            const msgEl = document.getElementById('steamAppListMessage');
            const query = document.getElementById('steamSearchQuery').value;
            if (!query) { msgEl.textContent = "Ingresa un término de búsqueda."; return; }
            msgEl.textContent = "Buscando...";
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/steam/search_games/?query=${encodeURIComponent(query)}`);
                const games = await handleApiResponse(res);
                if (!res.ok) throw new Error(games);
                msgEl.textContent = `Resultados para "${query}":`;
                listEl.innerHTML = games.map(g => `<div class="games-list-card"><span>${g.name} (AppID: ${g.id})</span><button onclick="importSteamGame(${g.id})">Importar a DB</button></div>`).join('');
            } catch(error) { msgEl.className='error'; msgEl.textContent=`Error: ${error.message}`; }
        }
        
        async function importSteamGame(appId) {
            const msgEl = document.getElementById('steamAppListMessage');
            msgEl.textContent = `Importando AppID ${appId}...`;
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/steam/import_game/${appId}`, { method: 'POST', headers: getAuthHeaders() });
                const data = await handleApiResponse(res);
                if (!res.ok) throw new Error(data);
                msgEl.className='success'; msgEl.textContent = `Juego "${data.title}" importado con éxito.`;
            } catch (error) { msgEl.className='error'; msgEl.textContent=`Error: ${error.message}`; }
        }
        
        async function getSteamGameDetails() {
            const msgEl = document.getElementById('steamApiMessage');
            const cardEl = document.getElementById('steamApiFormattedOutput');
            const appId = document.getElementById('steamAppIdInput').value;
            msgEl.textContent = "Buscando..."; cardEl.classList.add('hidden');
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/steam/game_details/${appId}`);
                const data = await handleApiResponse(res);
                if (!res.ok) throw new Error(data);
                cardEl.innerHTML = `
                    <img src="${data.header_image}" alt="Header for ${data.name}">
                    <div class="game-details-text-info">
                        <h3>${data.name}</h3>
                        <p><strong>Desarrollador:</strong> ${data.developers.join(', ')}</p>
                        <p><strong>Precio:</strong> ${data.price_overview ? data.price_overview.final_formatted : 'Gratis o N/A'}</p>
                        <div class="game-details-description">${data.short_description}</div>
                    </div>`;
                cardEl.classList.remove('hidden');
                msgEl.textContent = "Detalles encontrados.";
            } catch (error) { msgEl.className='error'; msgEl.textContent=`Error: ${error.message}`; }
        }

        async function performGameAnalysis() {
            const msgEl = document.getElementById('analysisMessage');
            const chartContainer = document.getElementById('playerCountChartContainer');
            const appIds = document.getElementById('analysisAppIds').value.split(',').map(id => id.trim()).filter(Boolean);
            if (appIds.length === 0) { msgEl.textContent = "Ingresa al menos un App ID."; return; }
            msgEl.textContent = 'Analizando...'; chartContainer.classList.add('hidden');
            try {
                const playersPromises = appIds.map(id => 
                    fetch(`${API_BASE_URL}/api/v1/steam/current_players/${id}`)
                        .then(res => res.ok ? res.json() : { player_count: 0 })
                        .catch(() => ({ player_count: 0 }))
                );
                const detailsPromises = appIds.map(id => 
                    fetch(`${API_BASE_URL}/api/v1/steam/game_details/${id}`)
                        .then(res => res.ok ? res.json() : { name: `AppID ${id}` })
                        .catch(() => ({ name: `AppID ${id}` }))
                );

                const playersResults = await Promise.all(playersPromises);
                const detailsResults = await Promise.all(detailsPromises);

                const chartData = {
                    labels: detailsResults.map(d => d.name),
                    datasets: [{
                        label: 'Jugadores Actuales',
                        data: playersResults.map(r => r.player_count),
                        backgroundColor: 'rgba(233, 69, 96, 0.6)',
                        borderColor: 'rgba(233, 69, 96, 1)',
                        borderWidth: 1
                    }]
                };
                if (myChart) myChart.destroy();
                myChart = new Chart(document.getElementById('playerCountChart').getContext('2d'), { type: 'bar', data: chartData, options: { maintainAspectRatio: false } });
                chartContainer.classList.remove('hidden');
                msgEl.textContent = 'Análisis completo.';
            } catch (error) { msgEl.className='error'; msgEl.textContent=`Error: ${error.message}`; }
        }
        
        // --- Profile ---
        async function loadProfile() {
            if (!currentUserId) return;
            document.getElementById('profileUsername').textContent = currentUsername;
            document.getElementById('profileUserId').textContent = currentUserId;
            try {
                const res = await fetch(`${API_BASE_URL}/api/v1/users/me/`, { headers: getAuthHeaders() });
                const user = await handleApiResponse(res);
                if(res.ok) document.getElementById('profileEmail').textContent = user.email;
            } catch(e) { console.error("Error fetching profile details"); }
            await getReviews(null, currentUserId, 'profileMessage', 'userReviewsList');
        }

        // --- Init & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            document.getElementById('apiStatus').textContent = 'Verificando API...';
            fetch(`${API_BASE_URL}/api/v1/games/`).then(res => {
                const statusDiv = document.getElementById('apiStatus');
                statusDiv.textContent = res.ok ? 'Estado de la API: Conectada.' : 'Estado de la API: Error.';
                statusDiv.className = res.ok ? 'success' : 'error';
            }).catch(err => {
                 const statusDiv = document.getElementById('apiStatus');
                 statusDiv.textContent = 'Error de red. No se puede conectar a la API.';
                 statusDiv.className = 'error';
            });
            
            document.getElementById('headerSearchInput').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    const query = this.value;
                    if (query) {
                        showSection('exploreSteamSection');
                        document.getElementById('steamSearchQuery').value = query;
                        searchSteamStore();
                    }
                }
            });

            document.querySelectorAll('.sidebar nav a').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const sectionId = e.currentTarget.id.replace('nav-', '') + 'Section';
                    showSection(sectionId);
                    if (sectionId === 'gamesSection') getGames();
                    if (sectionId === 'profileSection') loadProfile();
                    if (sectionId === 'viewReviewsSection') getReviews(null, null, 'viewReviewsMessage', 'reviewsList');
                });
            });
            document.getElementById('nav-logout').addEventListener('click', e => { e.preventDefault(); logoutUser(); });
        });

    </script>
</body>
</html>
