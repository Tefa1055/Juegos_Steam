<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Juegos Steam</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos Generales para el Fondo y Fuente */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a2e; /* Fondo oscuro similar al ejemplo */
            color: #e0e0e0; /* Texto claro */
            display: flex; /* Para el layout de sidebar y contenido */
            min-height: 100vh; /* Ocupa toda la altura de la ventana */
        }

        /* Contenedor Principal para el Dashboard */
        .dashboard-wrapper {
            display: flex;
            width: 100%;
        }

        /* Estilos del Sidebar (Menú Lateral) */
        .sidebar {
            width: 250px;
            background-color: #16213e; /* Fondo del sidebar más oscuro */
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Para empujar el logout al final */
        }

        .sidebar h2 {
            color: #00bcd4; /* Color de acento */
            text-align: center;
            margin-bottom: 30px;
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            flex-grow: 1; /* Permite que la lista crezca y ocupe espacio */
        }

        .sidebar ul li {
            margin-bottom: 10px;
        }

        .sidebar ul li a {
            color: #e0e0e0;
            text-decoration: none;
            padding: 10px 15px;
            display: block;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .sidebar ul li a:hover, .sidebar ul li a.active {
            background-color: #0f3460; /* Color de hover/activo */
        }

        .sidebar ul li a i {
            margin-right: 10px;
        }

        /* Contenido Principal */
        .main-content {
            flex-grow: 1; /* Ocupa el espacio restante */
            padding: 20px;
            background-color: #1a1a2e;
            overflow-y: auto; /* Para scroll si el contenido es largo */
        }

        /* Barra de Navegación Superior */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #0f3460; /* Color de la barra superior */
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .top-nav .search-bar input {
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #16213e;
            color: #e0e0e0;
            width: 300px;
        }

        .top-nav .user-info {
            color: #e0e0e0;
        }

        .top-nav .user-info span {
            margin-right: 10px;
        }

        .top-nav .user-info button {
            background-color: #e94560; /* Color del botón de logout */
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .top-nav .user-info button:hover {
            background-color: #be334a;
        }

        /* Secciones del Dashboard */
        .dashboard-section {
            background-color: #0f3460;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .dashboard-section h2 {
            color: #00bcd4;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Estilos de Tabla */
        .games-table-container {
            overflow-x: auto; /* Permite scroll horizontal en tablas grandes */
        }

        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 0.9em;
            min-width: 400px;
            border-radius: 5px 5px 0 0;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.15);
        }

        .styled-table thead tr {
            background-color: #00bcd4;
            color: #ffffff;
            text-align: left;
        }

        .styled-table th,
        .styled-table td {
            padding: 12px 15px;
        }

        .styled-table tbody tr {
            border-bottom: 1px solid #dddddd;
            background-color: #16213e; /* Filas de la tabla */
            color: #e0e0e0;
        }

        .styled-table tbody tr:nth-of-type(even) {
            background-color: #0f3460; /* Filas pares de la tabla */
        }

        .styled-table tbody tr:last-of-type {
            border-bottom: 2px solid #00bcd4;
        }

        .styled-table tbody tr.active-row {
            font-weight: bold;
            color: #00bcd4;
        }

        /* Formularios */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #e0e0e0;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group textarea {
            width: calc(100% - 22px); /* Ajustar padding y borde */
            padding: 10px;
            border: 1px solid #0f3460;
            border-radius: 5px;
            background-color: #1a1a2e;
            color: #e0e0e0;
            box-sizing: border-box; /* Incluir padding y borde en el ancho */
        }

        .form-group input[type="file"] {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #0f3460;
            border-radius: 5px;
            background-color: #1a1a2e;
            color: #e0e0e0;
            box-sizing: border-box;
        }

        .btn {
            background-color: #00bcd4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1em;
        }

        .btn-primary {
            background-color: #00bcd4;
        }

        .btn-primary:hover {
            background-color: #0097a7;
        }

        .btn-danger {
            background-color: #e94560;
        }

        .btn-danger:hover {
            background-color: #be334a;
        }

        /* Mensajes de estado */
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
        }

        .message.success {
            background-color: #4CAF50; /* Green */
            color: white;
        }

        .message.error {
            background-color: #f44336; /* Red */
            color: white;
        }

        /* Estilos específicos para la sección de exploración de Steam */
        .steam-explore-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .steam-explore-controls input[type="number"] {
            width: 120px;
        }

        .steam-details-container {
            margin-top: 20px;
            padding: 20px;
            background-color: #16213e;
            border-radius: 8px;
            display: flex; /* Para layout de imagen y texto */
            gap: 20px;
        }

        .steam-details-container img {
            max-width: 300px;
            height: auto;
            border-radius: 5px;
        }

        .steam-info {
            flex-grow: 1;
        }

        .steam-info h3 {
            color: #00bcd4;
            margin-top: 0;
        }

        .steam-info p {
            margin-bottom: 8px;
        }

        /* Login/Register Section */
        .auth-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a2e;
        }

        .auth-container {
            background-color: #0f3460;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-container h2 {
            color: #00bcd4;
            margin-bottom: 30px;
        }

        .auth-container .form-group {
            text-align: left;
        }

        .auth-container .btn {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
        }

        .auth-container .toggle-link {
            margin-top: 20px;
            color: #e0e0e0;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-container .toggle-link:hover {
            color: #00bcd4;
        }

        /* Gráficos Chart.js */
        .chart-container {
            background-color: #16213e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }

        .chart-container h3 {
            color: #00bcd4;
            text-align: center;
            margin-bottom: 20px;
        }

        canvas {
            max-width: 100%;
            height: auto;
        }

        /* Estilos para el modal */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; /* Permanece fijo en la pantalla */
            z-index: 1; /* Se superpone a otros elementos */
            left: 0;
            top: 0;
            width: 100%; /* Ancho completo */
            height: 100%; /* Alto completo */
            overflow: auto; /* Habilita el scroll si es necesario */
            background-color: rgba(0,0,0,0.7); /* Fondo oscuro semitransparente */
            justify-content: center; /* Centrar contenido horizontalmente */
            align-items: center; /* Centrar contenido verticalmente */
        }

        .modal-content {
            background-color: #0f3460;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 80%; /* Ancho del contenido */
            max-width: 600px; /* Ancho máximo */
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        /* Animación del modal */
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Estilos del spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00bcd4;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block; /* Para que esté en línea con el texto */
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ajustes para pantallas pequeñas */
        @media (max-width: 768px) {
            .dashboard-wrapper {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                padding: 15px;
            }

            .sidebar ul {
                flex-direction: row; /* Menú horizontal en móviles */
                flex-wrap: wrap;
                justify-content: center;
            }

            .sidebar ul li {
                margin: 5px;
            }

            .top-nav {
                flex-direction: column;
                align-items: flex-start;
            }

            .top-nav .search-bar input {
                width: 100%;
                margin-bottom: 10px;
            }

            .top-nav .user-info {
                width: 100%;
                text-align: right;
            }
        }
    </style>
</head>
<body>
    <div id="loginSection" class="auth-section">
        <div class="auth-container">
            <h2 id="authTitle">Iniciar Sesión</h2>
            <form id="authForm">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Entrar</button>
            </form>
            <p class="toggle-link" id="toggleAuthMode">¿No tienes cuenta? Regístrate aquí.</p>
        </div>
    </div>

    <div id="dashboard" class="dashboard-wrapper" style="display: none;">
        <aside class="sidebar">
            <div>
                <h2>Steam Dashboard</h2>
                <ul>
                    <li><a href="#" id="nav-games" class="active"><i class="fas fa-gamepad"></i> Mis Juegos</a></li>
                    <li><a href="#" id="nav-create-game"><i class="fas fa-plus-circle"></i> Crear Juego</a></li>
                    <li><a href="#" id="nav-create-review"><i class="fas fa-comment-dots"></i> Crear Reseña</a></li>
                    <li><a href="#" id="nav-view-reviews"><i class="fas fa-comments"></i> Ver Reseñas</a></li>
                    <li><a href="#" id="nav-explore-steam"><i class="fab fa-steam"></i> Explorar Steam</a></li>
                    <li><a href="#" id="nav-game-analysis"><i class="fas fa-chart-line"></i> Análisis de Juegos</a></li>
                    <li><a href="#" id="nav-profile"><i class="fas fa-user"></i> Mi Perfil</a></li>
                    <li><a href="#" id="nav-settings"><i class="fas fa-cog"></i> Ajustes</a></li>
                </ul>
            </div>
            <ul>
                <li><a href="#" id="nav-logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <nav class="top-nav">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Buscar juego, usuario...">
                    <button id="searchButton" class="btn btn-primary" style="margin-left: 10px;">Buscar</button>
                </div>
                <div class="user-info">
                    <span>Bienvenido, <span id="currentUsername"></span>!</span>
                </div>
            </nav>

            <section id="gamesSection" class="dashboard-section">
                <h2>Mis Juegos</h2>
                <div class="games-table-container">
                    <table id="gamesTable" class="styled-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Desarrollador</th>
                                <th>Editor</th>
                                <th>Géneros</th>
                                <th>Fecha de Lanzamiento</th>
                                <th>Precio</th>
                                <th>Steam App ID</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <h2 id="searchResultsTitle" style="display: none; margin-top: 30px; text-align: center;">Resultados de Búsqueda de Juegos</h2>
                <div class="games-table-container">
                    <table id="searchResultsTable" class="styled-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Título</th>
                                <th>Desarrollador</th>
                                <th>Editor</th>
                                <th>Géneros</th>
                                <th>Fecha de Lanzamiento</th>
                                <th>Precio</th>
                                <th>Steam App ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
                <div id="searchNoResults" style="display: none; text-align: center; margin-top: 20px;">
                    No se encontraron juegos con ese criterio de búsqueda.
                </div>
            </section>

            <section id="createGameSection" class="dashboard-section" style="display: none;">
                <h2>Crear Nuevo Juego</h2>
                <form id="createGameForm">
                    <div class="form-group">
                        <label for="gameTitle">Título:</label>
                        <input type="text" id="gameTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="gameDeveloper">Desarrollador:</label>
                        <input type="text" id="gameDeveloper">
                    </div>
                    <div class="form-group">
                        <label for="gamePublisher">Editor:</label>
                        <input type="text" id="gamePublisher">
                    </div>
                    <div class="form-group">
                        <label for="gameGenres">Géneros (separados por coma):</label>
                        <input type="text" id="gameGenres">
                    </div>
                    <div class="form-group">
                        <label for="gameReleaseDate">Fecha de Lanzamiento:</label>
                        <input type="date" id="gameReleaseDate">
                    </div>
                    <div class="form-group">
                        <label for="gamePrice">Precio:</label>
                        <input type="number" id="gamePrice" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="gameSteamAppId">Steam App ID:</label>
                        <input type="number" id="gameSteamAppId" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Crear Juego</button>
                </form>
            </section>

            <section id="createReviewSection" class="dashboard-section" style="display: none;">
                <h2>Crear Nueva Reseña</h2>
                <form id="createReviewForm">
                    <div class="form-group">
                        <label for="reviewGameId">ID del Juego:</label>
                        <select id="reviewGameId" required></select>
                    </div>
                    <div class="form-group">
                        <label for="reviewRating">Puntuación (1-5):</label>
                        <input type="number" id="reviewRating" min="1" max="5" required>
                    </div>
                    <div class="form-group">
                        <label for="reviewText">Texto de la Reseña:</label>
                        <textarea id="reviewText" rows="5"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="reviewImage">Imagen (opcional):</label>
                        <input type="file" id="reviewImage" accept="image/*">
                    </div>
                    <button type="submit" class="btn btn-primary">Crear Reseña</button>
                </form>
            </section>

            <section id="viewReviewsSection" class="dashboard-section" style="display: none;">
                <h2>Ver Reseñas</h2>
                <div class="form-group">
                    <label for="reviewsFilterGameId">Filtrar por Juego (ID):</label>
                    <select id="reviewsFilterGameId">
                        <option value="">Todas las reseñas</option>
                        </select>
                </div>
                <div class="games-table-container">
                    <table id="reviewsTable" class="styled-table">
                        <thead>
                            <tr>
                                <th>ID Reseña</th>
                                <th>Juego</th>
                                <th>Usuario</th>
                                <th>Puntuación</th>
                                <th>Reseña</th>
                                <th>Fecha</th>
                                <th>Imagen</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>

            <section id="exploreSteamSection" class="dashboard-section" style="display: none;">
                <h2>Explorar Juegos de Steam</h2>
                <div class="steam-explore-controls">
                    <input type="number" id="steamAppIdInput" placeholder="Introduce App ID" min="1">
                    <button id="getSteamDetailsBtn" class="btn btn-primary">Obtener Detalles de Steam</button>
                    <button id="addToDbFromSteamDetailsBtn" class="btn btn-primary" style="display: none;">Añadir a mi BD</button>
                </div>
                <div id="steamDetailsResult" class="steam-details-container" style="display: none;">
                    </div>
                <div id="steamDetailsNoResult" style="text-align: center; margin-top: 20px; display: none;">
                    No se encontraron detalles para el App ID proporcionado.
                </div>
            </section>
            
            <section id="gameAnalysisSection" class="dashboard-section" style="display: none;">
                <h2>Análisis de Juegos</h2>
                <div class="chart-container">
                    <h3>Juegos por Desarrollador</h3>
                    <canvas id="developerChart"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 30px;">
                    <h3>Juegos por Género</h3>
                    <canvas id="genreChart"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 30px;">
                    <h3>Juegos por Año de Lanzamiento</h3>
                    <canvas id="releaseYearChart"></canvas>
                </div>
            </section>

            <section id="profileSection" class="dashboard-section" style="display: none;">
                <h2>Mi Perfil</h2>
                <div id="profileDetails">
                    <p><strong>Usuario:</strong> <span id="profileUsername"></span></p>
                    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                    <p><strong>Fecha de registro:</strong> <span id="profileCreatedAt"></span></p>
                    <h3>Mis Reseñas:</h3>
                    <div class="games-table-container">
                        <table id="userReviewsTable" class="styled-table">
                            <thead>
                                <tr>
                                    <th>ID Reseña</th>
                                    <th>Juego</th>
                                    <th>Puntuación</th>
                                    <th>Reseña</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                    <p id="noUserReviews" style="display: none; text-align: center;">No has escrito ninguna reseña todavía.</p>
                </div>
            </section>

            <section id="settingsSection" class="dashboard-section" style="display: none;">
                <h2>Ajustes</h2>
                <p>Aquí podrías tener opciones de configuración de la cuenta.</p>
            </section>

        </main>
    </div>

    <div id="updateGameModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Editar Juego</h2>
            <form id="updateGameForm">
                <input type="hidden" id="updateGameId">
                <div class="form-group">
                    <label for="updateGameTitle">Título:</label>
                    <input type="text" id="updateGameTitle" required>
                </div>
                <div class="form-group">
                    <label for="updateGameDeveloper">Desarrollador:</label>
                    <input type="text" id="updateGameDeveloper">
                </div>
                <div class="form-group">
                    <label for="updateGamePublisher">Editor:</label>
                    <input type="text" id="updateGamePublisher">
                </div>
                <div class="form-group">
                    <label for="updateGameGenres">Géneros (separados por coma):</label>
                    <input type="text" id="updateGameGenres">
                </div>
                <div class="form-group">
                    <label for="updateGameReleaseDate">Fecha de Lanzamiento:</label>
                    <input type="date" id="updateGameReleaseDate">
                </div>
                <div class="form-group">
                    <label for="updateGamePrice">Precio:</label>
                    <input type="number" id="updateGamePrice" step="0.01" min="0">
                </div>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div id="updateReviewModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeReviewModalBtn">&times;</span>
            <h2>Editar Reseña</h2>
            <form id="updateReviewForm">
                <input type="hidden" id="updateReviewId">
                <div class="form-group">
                    <label for="updateReviewRating">Puntuación (1-5):</label>
                    <input type="number" id="updateReviewRating" min="1" max="5" required>
                </div>
                <div class="form-group">
                    <label for="updateReviewText">Texto de la Reseña:</label>
                    <textarea id="updateReviewText" rows="5"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </form>
        </div>
    </div>


    <script>
        const API_BASE_URL = window.location.origin; // Asume que el backend está en el mismo origen

        // --- Funciones de Utilidad ---
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `message ${type}`;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000); // Ocultar después de 5 segundos
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            // Actualizar clase activa en el sidebar
            document.querySelectorAll('.sidebar ul li a').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(`nav-${sectionId.replace('Section', '')}`).classList.add('active');
            
            // Ocultar resultados de búsqueda al cambiar de sección, a menos que sea la sección de juegos
            if (sectionId !== 'gamesSection') {
                document.getElementById('searchResultsTable').style.display = 'none';
                document.getElementById('searchResultsTitle').style.display = 'none';
                document.getElementById('searchNoResults').style.display = 'none';
                // También restaurar la tabla principal de juegos si estaba oculta
                document.getElementById('gamesTable').style.display = 'table';
                document.getElementById('gamesTitle').style.display = 'block'; // Asumiendo que tienes un título para la tabla principal
            }
        }

        // --- Autenticación y Navegación ---
        document.addEventListener('DOMContentLoaded', () => {
            const loginSection = document.getElementById('loginSection');
            const dashboard = document.getElementById('dashboard');
            const authForm = document.getElementById('authForm');
            const toggleAuthMode = document.getElementById('toggleAuthMode');
            const authTitle = document.getElementById('authTitle');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const currentUsernameSpan = document.getElementById('currentUsername');

            let isLoginMode = true; // Estado inicial: login

            const checkAuth = () => {
                const token = localStorage.getItem('access_token');
                if (token) {
                    loginSection.style.display = 'none';
                    dashboard.style.display = 'flex';
                    // Intentar cargar el nombre de usuario desde el token o una API /me
                    loadCurrentUserProfile();
                    loadGames(); // Cargar juegos al iniciar
                    loadGameOptionsForReviews(); // Cargar opciones de juegos para crear reseñas
                    loadReviews(); // Cargar todas las reseñas
                    renderCharts(); // Renderizar gráficos
                    showSection('gamesSection'); // Mostrar la sección de juegos por defecto
                } else {
                    loginSection.style.display = 'flex';
                    dashboard.style.display = 'none';
                }
            };

            const loadCurrentUserProfile = async () => {
                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) return;
                    const response = await fetch(`${API_BASE_URL}/api/v1/users/me/`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    if (response.ok) {
                        const user = await response.json();
                        currentUsernameSpan.textContent = user.username;
                    } else {
                        console.error('Error al cargar el perfil del usuario actual:', await response.json());
                        logoutUser(); // Si el token no es válido, cerrar sesión
                    }
                } catch (error) {
                    console.error('Error de red al cargar el perfil del usuario actual:', error);
                    logoutUser(); // Si hay un error de red, cerrar sesión
                }
            };


            toggleAuthMode.addEventListener('click', () => {
                isLoginMode = !isLoginMode;
                if (isLoginMode) {
                    authTitle.textContent = 'Iniciar Sesión';
                    toggleAuthMode.textContent = '¿No tienes cuenta? Regístrate aquí.';
                } else {
                    authTitle.textContent = 'Registrarse';
                    toggleAuthMode.textContent = '¿Ya tienes cuenta? Inicia sesión aquí.';
                }
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = usernameInput.value;
                const password = passwordInput.value;

                let url, method, body;

                if (isLoginMode) {
                    url = `${API_BASE_URL}/token`;
                    method = 'POST';
                    const formData = new URLSearchParams();
                    formData.append('username', username);
                    formData.append('password', password);
                    body = formData; // FormData para x-www-form-urlencoded
                } else {
                    url = `${API_BASE_URL}/api/v1/usuarios`;
                    method = 'POST';
                    body = JSON.stringify({ username, password, email: `${username}@example.com` }); // Usar email genérico por ahora
                }

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: isLoginMode ? { /* FastAPI maneja el Content-Type para form data */ } : { 'Content-Type': 'application/json' },
                        body: body
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (isLoginMode) {
                            localStorage.setItem('access_token', data.access_token);
                            checkAuth();
                        } else {
                            alert('Registro exitoso. Ahora puedes iniciar sesión.');
                            isLoginMode = true; // Volver a modo login
                            authTitle.textContent = 'Iniciar Sesión';
                            toggleAuthMode.textContent = '¿No tienes cuenta? Regístrate aquí.';
                            authForm.reset(); // Limpiar formulario
                        }
                    } else {
                        const errorData = await response.json();
                        alert(`Error: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red o inesperado:', error);
                    alert('Error de conexión o inesperado.');
                }
            });

            const logoutUser = () => {
                localStorage.removeItem('access_token');
                checkAuth();
                // Limpiar cualquier estado o tabla si es necesario
                document.querySelector('#gamesTable tbody').innerHTML = '';
                document.querySelector('#reviewsTable tbody').innerHTML = '';
                document.querySelector('#userReviewsTable tbody').innerHTML = '';
                document.getElementById('steamDetailsResult').style.display = 'none';
                document.getElementById('steamDetailsNoResult').style.display = 'none';
                document.getElementById('addToDbFromSteamDetailsBtn').style.display = 'none';
                displayedSteamAppId = null; // Limpiar ID de Steam mostrado
            };

            // Event Listeners para la navegación del sidebar
            document.getElementById('nav-games').addEventListener('click', (e) => { e.preventDefault(); showSection('gamesSection'); });
            document.getElementById('nav-create-game').addEventListener('click', (e) => { e.preventDefault(); showSection('createGameSection'); });
            document.getElementById('nav-create-review').addEventListener('click', (e) => { e.preventDefault(); showSection('createReviewSection'); });
            document.getElementById('nav-view-reviews').addEventListener('click', (e) => { e.preventDefault(); showSection('viewReviewsSection'); });
            document.getElementById('nav-explore-steam').addEventListener('click', (e) => { e.preventDefault(); showSection('exploreSteamSection'); });
            document.getElementById('nav-game-analysis').addEventListener('click', (e) => { e.preventDefault(); showSection('gameAnalysisSection'); });
            document.getElementById('nav-profile').addEventListener('click', (e) => { e.preventDefault(); showSection('profileSection'); loadUserProfile(); }); // Load profile on click
            document.getElementById('nav-settings').addEventListener('click', (e) => { e.preventDefault(); showSection('settingsSection'); });
            document.getElementById('nav-logout').addEventListener('click', (e) => { e.preventDefault(); logoutUser(); });

            checkAuth(); // Verificar autenticación al cargar la página


            // --- Gestión de Juegos ---
            const gamesTableBody = document.querySelector('#gamesTable tbody');
            const createGameForm = document.getElementById('createGameForm');

            async function loadGames() {
                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const games = await response.json();
                        gamesTableBody.innerHTML = ''; // Limpiar la tabla
                        games.forEach(game => {
                            const row = gamesTableBody.insertRow();
                            row.insertCell().textContent = game.id;
                            row.insertCell().textContent = game.title;
                            row.insertCell().textContent = game.developer || 'N/A';
                            row.insertCell().textContent = game.publisher || 'N/A';
                            row.insertCell().textContent = game.genres || 'N/A';
                            row.insertCell().textContent = game.release_date || 'N/A';
                            row.insertCell().textContent = game.price !== null ? `$${game.price.toFixed(2)}` : 'N/A';
                            row.insertCell().textContent = game.steam_app_id;

                            const actionsCell = row.insertCell();
                            const editButton = document.createElement('button');
                            editButton.textContent = 'Editar';
                            editButton.classList.add('btn', 'btn-primary');
                            editButton.onclick = () => openEditGameModal(game);
                            actionsCell.appendChild(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Eliminar';
                            deleteButton.classList.add('btn', 'btn-danger');
                            deleteButton.style.marginLeft = '5px';
                            deleteButton.onclick = () => deleteGame(game.id);
                            actionsCell.appendChild(deleteButton);
                        });
                    } else {
                        console.error('Error al cargar juegos:', await response.json());
                    }
                } catch (error) {
                    console.error('Error de red al cargar juegos:', error);
                }
            }

            createGameForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('No estás autenticado.');
                    return;
                }

                const gameData = {
                    title: document.getElementById('gameTitle').value,
                    developer: document.getElementById('gameDeveloper').value || null,
                    publisher: document.getElementById('gamePublisher').value || null,
                    genres: document.getElementById('gameGenres').value || null,
                    release_date: document.getElementById('gameReleaseDate').value || null,
                    price: parseFloat(document.getElementById('gamePrice').value) || 0.0,
                    steam_app_id: parseInt(document.getElementById('gameSteamAppId').value)
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(gameData)
                    });

                    if (response.ok) {
                        alert('Juego creado exitosamente!');
                        createGameForm.reset();
                        loadGames(); // Recargar la lista de juegos
                        loadGameOptionsForReviews(); // Recargar opciones de juegos para reseñas
                        showSection('gamesSection'); // Volver a la sección de juegos
                    } else {
                        const errorData = await response.json();
                        alert(`Error al crear juego: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red al crear juego:', error);
                    alert('Error de conexión o inesperado al crear juego.');
                }
            });

            // --- Modal de Edición de Juego ---
            const updateGameModal = document.getElementById('updateGameModal');
            const closeGameModalButton = updateGameModal.querySelector('.close-button');
            const updateGameForm = document.getElementById('updateGameForm');

            function openEditGameModal(game) {
                document.getElementById('updateGameId').value = game.id;
                document.getElementById('updateGameTitle').value = game.title;
                document.getElementById('updateGameDeveloper').value = game.developer || '';
                document.getElementById('updateGamePublisher').value = game.publisher || '';
                document.getElementById('updateGameGenres').value = game.genres || '';
                document.getElementById('updateGameReleaseDate').value = game.release_date || '';
                document.getElementById('updateGamePrice').value = game.price;
                updateGameModal.style.display = 'flex'; // Usar flex para centrar
            }

            closeGameModalButton.onclick = () => {
                updateGameModal.style.display = 'none';
            };

            window.onclick = (event) => {
                if (event.target == updateGameModal) {
                    updateGameModal.style.display = 'none';
                }
                if (event.target == updateReviewModal) { // Para cerrar también el modal de reseña
                    updateReviewModal.style.display = 'none';
                }
            };

            updateGameForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('access_token');
                if (!token) return;

                const gameId = document.getElementById('updateGameId').value;
                const gameUpdateData = {
                    title: document.getElementById('updateGameTitle').value,
                    developer: document.getElementById('updateGameDeveloper').value || null,
                    publisher: document.getElementById('updateGamePublisher').value || null,
                    genres: document.getElementById('updateGameGenres').value || null,
                    release_date: document.getElementById('updateGameReleaseDate').value || null,
                    price: parseFloat(document.getElementById('updateGamePrice').value) || 0.0,
                    // steam_app_id no se actualiza en este formulario, asume que es inmutable
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos/${gameId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(gameUpdateData)
                    });

                    if (response.ok) {
                        alert('Juego actualizado exitosamente!');
                        updateGameModal.style.display = 'none';
                        loadGames(); // Recargar la lista de juegos
                    } else {
                        const errorData = await response.json();
                        alert(`Error al actualizar juego: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red al actualizar juego:', error);
                    alert('Error de conexión o inesperado al actualizar juego.');
                }
            });

            async function deleteGame(gameId) {
                if (!confirm('¿Estás seguro de que quieres eliminar este juego? Esta acción es reversible (eliminación lógica).')) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('No estás autenticado.');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos/${gameId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 204) { // 204 No Content para eliminación exitosa
                        alert('Juego eliminado lógicamente!');
                        loadGames(); // Recargar la lista de juegos
                        loadGameOptionsForReviews(); // Recargar opciones de juegos
                        loadReviews(); // Recargar reseñas por si alguna estaba asociada
                    } else {
                        const errorData = await response.json();
                        alert(`Error al eliminar juego: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red al eliminar juego:', error);
                    alert('Error de conexión o inesperado al eliminar juego.');
                }
            }


            // --- Gestión de Reseñas ---
            const createReviewForm = document.getElementById('createReviewForm');
            const reviewGameIdSelect = document.getElementById('reviewGameId');
            const reviewsTableBody = document.querySelector('#reviewsTable tbody');
            const reviewsFilterGameIdSelect = document.getElementById('reviewsFilterGameId');

            async function loadGameOptionsForReviews() {
                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) return;

                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const games = await response.json();
                        reviewGameIdSelect.innerHTML = '<option value="">Selecciona un juego</option>';
                        reviewsFilterGameIdSelect.innerHTML = '<option value="">Todas las reseñas</option>'; // Opción para "todas"
                        games.forEach(game => {
                            const optionCreate = document.createElement('option');
                            optionCreate.value = game.id;
                            optionCreate.textContent = game.title;
                            reviewGameIdSelect.appendChild(optionCreate);

                            const optionFilter = document.createElement('option');
                            optionFilter.value = game.id;
                            optionFilter.textContent = game.title;
                            reviewsFilterGameIdSelect.appendChild(optionFilter);
                        });
                    } else {
                        console.error('Error al cargar juegos para opciones de reseña:', await response.json());
                    }
                } catch (error) {
                    console.error('Error de red al cargar juegos para opciones de reseña:', error);
                }
            }

            createReviewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('No estás autenticado.');
                    return;
                }

                const reviewGameId = document.getElementById('reviewGameId').value;
                const reviewRating = document.getElementById('reviewRating').value;
                const reviewText = document.getElementById('reviewText').value;
                const reviewImageFile = document.getElementById('reviewImage').files[0];

                if (!reviewGameId) {
                    alert('Por favor, selecciona un juego.');
                    return;
                }

                let imageUrl = null;
                if (reviewImageFile) {
                    const formData = new FormData();
                    formData.append('file', reviewImageFile);
                    try {
                        // Simular la carga de imagen
                        const uploadResponse = await fetch(`${API_BASE_URL}/api/v1/upload_image`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });
                        if (uploadResponse.ok) {
                            const uploadData = await uploadResponse.json();
                            imageUrl = uploadData.url; // URL simulada
                            alert('Imagen cargada (simuladamente) y lista para asociar con la reseña.');
                        } else {
                            const errorData = await uploadResponse.json();
                            alert(`Error al cargar imagen: ${errorData.detail || uploadResponse.statusText}`);
                            return; // No continuar si la carga de imagen falla
                        }
                    } catch (uploadError) {
                        console.error('Error de red al cargar imagen:', uploadError);
                        alert('Error de conexión o inesperado al cargar imagen.');
                        return;
                    }
                }

                const reviewData = {
                    rating: parseInt(reviewRating),
                    review_text: reviewText || null,
                    image_filename: imageUrl // Guardar la URL simulada
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/reviews?game_id=${reviewGameId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(reviewData)
                    });

                    if (response.ok) {
                        alert('Reseña creada exitosamente!');
                        createReviewForm.reset();
                        loadReviews(); // Recargar la lista de reseñas
                        loadUserProfile(); // Recargar el perfil del usuario para ver nuevas reseñas
                        showSection('viewReviewsSection'); // Volver a la sección de ver reseñas
                    } else {
                        const errorData = await response.json();
                        alert(`Error al crear reseña: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red al crear reseña:', error);
                    alert('Error de conexión o inesperado al crear reseña.');
                }
            });

            async function loadReviews(gameId = null) {
                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) return;

                    let url = `${API_BASE_URL}/api/v1/reviews`;
                    if (gameId) {
                        url = `${API_BASE_URL}/api/v1/juegos/${gameId}/reviews`;
                    }

                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const reviews = await response.json();
                        reviewsTableBody.innerHTML = ''; // Limpiar la tabla
                        if (reviews.length === 0) {
                            reviewsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay reseñas disponibles.</td></tr>';
                            return;
                        }

                        for (const review of reviews) {
                            const row = reviewsTableBody.insertRow();
                            row.insertCell().textContent = review.id;
                            
                            // Obtener detalles del juego si es necesario (la API devuelve GameReadWithReviews)
                            const gameTitle = review.game ? review.game.title : 'Cargando...';
                            row.insertCell().textContent = gameTitle;

                            // Obtener detalles del usuario si es necesario
                            const username = review.user ? review.user.username : 'Cargando...';
                            row.insertCell().textContent = username;

                            row.insertCell().textContent = review.rating;
                            row.insertCell().textContent = review.review_text || 'N/A';
                            row.insertCell().textContent = new Date(review.created_at).toLocaleDateString();
                            
                            const imageCell = row.insertCell();
                            if (review.image_filename) {
                                const img = document.createElement('img');
                                img.src = review.image_filename; // Asumiendo que esta URL es accesible
                                img.alt = 'Review Image';
                                img.style.maxWidth = '100px';
                                img.style.height = 'auto';
                                imageCell.appendChild(img);
                            } else {
                                imageCell.textContent = 'N/A';
                            }

                            const actionsCell = row.insertCell();
                            const editButton = document.createElement('button');
                            editButton.textContent = 'Editar';
                            editButton.classList.add('btn', 'btn-primary');
                            editButton.onclick = () => openEditReviewModal(review);
                            actionsCell.appendChild(editButton);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Eliminar';
                            deleteButton.classList.add('btn', 'btn-danger');
                            deleteButton.style.marginLeft = '5px';
                            deleteButton.onclick = () => deleteReview(review.id);
                            actionsCell.appendChild(deleteButton);
                        }
                    } else {
                        const errorData = await response.json();
                        reviewsTableBody.innerHTML = `<tr><td colspan="8" style="text-align: center; color: red;">Error al cargar reseñas: ${errorData.detail || response.statusText}</td></tr>`;
                        console.error('Error al cargar reseñas:', errorData);
                    }
                } catch (error) {
                    console.error('Error de red al cargar reseñas:', error);
                    reviewsTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error de conexión o inesperado al cargar reseñas.</td></tr>';
                }
            }

            reviewsFilterGameIdSelect.addEventListener('change', (e) => {
                const selectedGameId = e.target.value;
                loadReviews(selectedGameId ? parseInt(selectedGameId) : null);
            });

            // --- Modal de Edición de Reseña ---
            const updateReviewModal = document.getElementById('updateReviewModal');
            const closeReviewModalBtn = document.getElementById('closeReviewModalBtn');
            const updateReviewForm = document.getElementById('updateReviewForm');

            function openEditReviewModal(review) {
                document.getElementById('updateReviewId').value = review.id;
                document.getElementById('updateReviewRating').value = review.rating;
                document.getElementById('updateReviewText').value = review.review_text || '';
                updateReviewModal.style.display = 'flex';
            }

            closeReviewModalBtn.onclick = () => {
                updateReviewModal.style.display = 'none';
            };

            updateReviewForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('access_token');
                if (!token) return;

                const reviewId = document.getElementById('updateReviewId').value;
                const reviewUpdateData = {
                    rating: parseInt(document.getElementById('updateReviewRating').value),
                    review_text: document.getElementById('updateReviewText').value || null
                };

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/reviews/${reviewId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(reviewUpdateData)
                    });

                    if (response.ok) {
                        alert('Reseña actualizada exitosamente!');
                        updateReviewModal.style.display = 'none';
                        loadReviews(); // Recargar la lista de reseñas
                        loadUserProfile(); // Recargar el perfil para actualizar las reseñas del usuario
                    } else {
                        const errorData = await response.json();
                        alert(`Error al actualizar reseña: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red al actualizar reseña:', error);
                    alert('Error de conexión o inesperado al actualizar reseña.');
                }
            });

            async function deleteReview(reviewId) {
                if (!confirm('¿Estás seguro de que quieres eliminar esta reseña?')) {
                    return;
                }

                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('No estás autenticado.');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/reviews/${reviewId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.status === 204) {
                        alert('Reseña eliminada lógicamente!');
                        loadReviews();
                        loadUserProfile(); // Recargar el perfil para actualizar las reseñas del usuario
                    } else {
                        const errorData = await response.json();
                        alert(`Error al eliminar reseña: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red al eliminar reseña:', error);
                    alert('Error de conexión o inesperado al eliminar reseña.');
                }
            }


            // --- Explorar Steam ---
            const steamAppIdInput = document.getElementById('steamAppIdInput');
            const getSteamDetailsBtn = document.getElementById('getSteamDetailsBtn');
            const steamDetailsResult = document.getElementById('steamDetailsResult');
            const steamDetailsNoResult = document.getElementById('steamDetailsNoResult');
            const addToDbFromSteamDetailsBtn = document.getElementById('addToDbFromSteamDetailsBtn');

            let displayedSteamAppId = null; // Para guardar el App ID del juego mostrado

            getSteamDetailsBtn.addEventListener('click', async () => {
                const app_id = steamAppIdInput.value;
                if (!app_id) {
                    alert('Por favor, introduce un App ID de Steam.');
                    return;
                }

                steamDetailsResult.style.display = 'none';
                steamDetailsNoResult.style.display = 'none';
                addToDbFromSteamDetailsBtn.style.display = 'none';
                displayedSteamAppId = null;

                // Añadir spinner
                getSteamDetailsBtn.innerHTML = 'Obteniendo... <span class="spinner"></span>';
                getSteamDetailsBtn.disabled = true;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/steam/game_details/${app_id}`);
                    if (response.ok) {
                        const details = await response.json();
                        steamDetailsResult.innerHTML = `
                            <img src="${details.header_image}" alt="${details.name}">
                            <div class="steam-info">
                                <h3>${details.name}</h3>
                                <p><strong>Descripción:</strong> ${details.short_description || 'N/A'}</p>
                                <p><strong>Desarrollador:</strong> ${details.developers ? details.developers.join(', ') : 'N/A'}</p>
                                <p><strong>Editor:</strong> ${details.publishers ? details.publishers.join(', ') : 'N/A'}</p>
                                <p><strong>Géneros:</strong> ${details.genres ? details.genres.join(', ') : 'N/A'}</p>
                                <p><strong>Fecha de Lanzamiento:</strong> ${details.release_date || 'N/A'}</p>
                                <p><strong>Precio:</strong> ${details.price || 'N/A'}</p>
                                <p><strong>Steam App ID:</strong> ${details.app_id}</p>
                            </div>
                        `;
                        steamDetailsResult.style.display = 'flex';
                        displayedSteamAppId = details.app_id; // Guardar el App ID
                        addToDbFromSteamDetailsBtn.style.display = 'block'; // Mostrar botón "Añadir a mi BD"
                    } else if (response.status === 404) {
                        steamDetailsNoResult.style.display = 'block';
                    } else {
                        const errorData = await response.json();
                        alert(`Error al obtener detalles de Steam: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red o inesperado al obtener detalles de Steam:', error);
                    alert('Error de conexión o inesperado al obtener detalles de Steam.');
                } finally {
                    getSteamDetailsBtn.innerHTML = 'Obtener Detalles de Steam';
                    getSteamDetailsBtn.disabled = false;
                }
            });

            // NEW: Add event listener for the "Add to my DB" button
            document.getElementById('addToDbFromSteamDetailsBtn').addEventListener('click', () => {
                if (displayedSteamAppId) {
                    addSteamGameToDb(displayedSteamAppId);
                } else {
                    alert('No hay un App ID de Steam disponible para agregar a la base de datos.'); // Reemplazar con modal si se desea
                }
            });

            async function addSteamGameToDb(appId) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    alert('No estás autenticado. Por favor, inicia sesión.');
                    return;
                }

                if (!confirm(`¿Estás seguro de que quieres añadir el juego con App ID ${appId} a tu base de datos?`)) {
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos/from_steam?app_id=${appId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const newGame = await response.json();
                        alert(`Juego "${newGame.title}" (App ID: ${newGame.steam_app_id}) añadido exitosamente a tu base de datos local!`);
                        loadGames(); // Recargar la lista de juegos para mostrar el nuevo
                        loadGameOptionsForReviews(); // Asegurar que el nuevo juego aparezca en los selectores
                        showSection('gamesSection'); // Navegar a la sección de juegos
                    } else {
                        const errorData = await response.json();
                        alert(`Error al añadir juego de Steam a la base de datos: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red o inesperado al añadir juego de Steam a la base de datos:', error);
                    alert('Error de conexión o inesperado al añadir juego de Steam.');
                }
            }


            // --- Perfil de Usuario ---
            const profileUsernameSpan = document.getElementById('profileUsername');
            const profileEmailSpan = document.getElementById('profileEmail');
            const profileCreatedAtSpan = document.getElementById('profileCreatedAt');
            const userReviewsTableBody = document.querySelector('#userReviewsTable tbody');
            const noUserReviewsMessage = document.getElementById('noUserReviews');

            async function loadUserProfile() {
                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        noUserReviewsMessage.style.display = 'block';
                        return;
                    }

                    const response = await fetch(`${API_BASE_URL}/api/v1/users/me/`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const user = await response.json();
                        profileUsernameSpan.textContent = user.username;
                        profileEmailSpan.textContent = user.email;
                        profileCreatedAtSpan.textContent = new Date(user.created_at).toLocaleDateString();

                        // Cargar reseñas del usuario
                        const reviewsResponse = await fetch(`${API_BASE_URL}/api/v1/usuarios/${user.id}/reviews`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (reviewsResponse.ok) {
                            const userReviews = await reviewsResponse.json();
                            userReviewsTableBody.innerHTML = '';
                            if (userReviews.length > 0) {
                                noUserReviewsMessage.style.display = 'none';
                                for (const review of userReviews) {
                                    const row = userReviewsTableBody.insertRow();
                                    row.insertCell().textContent = review.id;
                                    // Fetch game details for the review
                                    try {
                                        const gameDetailsResponse = await fetch(`${API_BASE_URL}/api/v1/juegos/${review.game_id}`, {
                                            headers: {
                                                'Authorization': `Bearer ${token}`
                                            }
                                        });
                                        if (gameDetailsResponse.ok) {
                                            const game = await gameDetailsResponse.json();
                                            row.insertCell().textContent = game.title;
                                        } else {
                                            row.insertCell().textContent = 'Juego no encontrado';
                                        }
                                    } catch (gameError) {
                                        row.insertCell().textContent = 'Error al cargar juego';
                                        console.error('Error al cargar juego para reseña de perfil:', gameError);
                                    }
                                    row.insertCell().textContent = review.rating;
                                    row.insertCell().textContent = review.review_text || 'N/A';
                                    row.insertCell().textContent = new Date(review.created_at).toLocaleDateString();

                                    const actionsCell = row.insertCell();
                                    const editButton = document.createElement('button');
                                    editButton.textContent = 'Editar';
                                    editButton.classList.add('btn', 'btn-primary');
                                    editButton.onclick = () => openEditReviewModal(review);
                                    actionsCell.appendChild(editButton);

                                    const deleteButton = document.createElement('button');
                                    deleteButton.textContent = 'Eliminar';
                                    deleteButton.classList.add('btn', 'btn-danger');
                                    deleteButton.style.marginLeft = '5px';
                                    deleteButton.onclick = () => deleteReview(review.id);
                                    actionsCell.appendChild(deleteButton);
                                }
                            } else {
                                noUserReviewsMessage.style.display = 'block';
                            }
                        } else {
                            const errorData = await reviewsResponse.json();
                            alert(`Error al cargar reseñas del usuario: ${errorData.detail || reviewsResponse.statusText}`);
                            noUserReviewsMessage.style.display = 'block';
                        }
                    } else {
                        const errorData = await response.json();
                        alert(`Error al cargar perfil del usuario: ${errorData.detail || response.statusText}`);
                    }
                } catch (error) {
                    console.error('Error de red al cargar perfil del usuario:', error);
                    alert('Error de conexión o inesperado al cargar perfil del usuario.');
                }
            }

            // --- Gráficos (Chart.js) ---
            async function renderCharts() {
                const token = localStorage.getItem('access_token');
                if (!token) return;

                try {
                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    if (response.ok) {
                        const games = await response.json();

                        // Chart 1: Games by Developer
                        const developerCounts = {};
                        games.forEach(game => {
                            const dev = game.developer || 'Desconocido';
                            developerCounts[dev] = (developerCounts[dev] || 0) + 1;
                        });
                        new Chart(document.getElementById('developerChart'), {
                            type: 'bar',
                            data: {
                                labels: Object.keys(developerCounts),
                                datasets: [{
                                    label: 'Número de Juegos',
                                    data: Object.values(developerCounts),
                                    backgroundColor: 'rgba(0, 188, 212, 0.6)',
                                    borderColor: 'rgba(0, 188, 212, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true, ticks: { color: '#e0e0e0' } },
                                    x: { ticks: { color: '#e0e0e0' } }
                                },
                                plugins: { legend: { labels: { color: '#e0e0e0' } } }
                            }
                        });

                        // Chart 2: Games by Genre
                        const genreCounts = {};
                        games.forEach(game => {
                            const genres = (game.genres || 'Sin Género').split(', ').map(g => g.trim());
                            genres.forEach(genre => {
                                genreCounts[genre] = (genreCounts[genre] || 0) + 1;
                            });
                        });
                        new Chart(document.getElementById('genreChart'), {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(genreCounts),
                                datasets: [{
                                    label: 'Número de Juegos',
                                    data: Object.values(genreCounts),
                                    backgroundColor: [
                                        'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)',
                                        'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)',
                                        'rgba(199, 199, 199, 0.6)'
                                    ],
                                    borderColor: [
                                        'rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)',
                                        'rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)', 'rgba(255, 159, 64, 1)',
                                        'rgba(199, 199, 199, 1)'
                                    ],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                plugins: { legend: { labels: { color: '#e0e0e0' } } }
                            }
                        });

                        // Chart 3: Games by Release Year
                        const releaseYearCounts = {};
                        games.forEach(game => {
                            const year = game.release_date ? new Date(game.release_date).getFullYear() : 'Desconocido';
                            releaseYearCounts[year] = (releaseYearCounts[year] || 0) + 1;
                        });
                        // Ordenar por año
                        const sortedYears = Object.keys(releaseYearCounts).sort((a, b) => {
                            if (a === 'Desconocido') return 1;
                            if (b === 'Desconocido') return -1;
                            return parseInt(a) - parseInt(b);
                        });
                        const sortedCounts = sortedYears.map(year => releaseYearCounts[year]);

                        new Chart(document.getElementById('releaseYearChart'), {
                            type: 'line',
                            data: {
                                labels: sortedYears,
                                datasets: [{
                                    label: 'Juegos Lanzados',
                                    data: sortedCounts,
                                    fill: false,
                                    borderColor: 'rgb(75, 192, 192)',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true, ticks: { color: '#e0e0e0' } },
                                    x: { ticks: { color: '#e0e0e0' } }
                                },
                                plugins: { legend: { labels: { color: '#e0e0e0' } } }
                            }
                        });


                    } else {
                        console.error('Error al cargar datos para gráficos:', await response.json());
                    }
                } catch (error) {
                    console.error('Error de red al cargar datos para gráficos:', error);
                }
            }

            // === Funcionalidad de Búsqueda ===
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton');
            const searchResultsTableBody = document.querySelector('#searchResultsTable tbody');
            const searchResultsTable = document.getElementById('searchResultsTable');
            const searchResultsTitle = document.getElementById('searchResultsTitle');
            const searchNoResults = document.getElementById('searchNoResults');
            const gamesTable = document.getElementById('gamesTable'); // Referencia a la tabla principal
            const gamesTitle = document.querySelector('#gamesSection h2'); // Título de la sección principal de juegos

            // Asignar listeners solo si los elementos existen (para evitar errores si no están en todas las secciones)
            if (searchButton && searchInput) {
                searchButton.addEventListener('click', performSearch);
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }

            async function performSearch() {
                const query = searchInput.value.trim();
                if (!query) {
                    alert('Por favor, ingresa un término de búsqueda.');
                    return;
                }

                try {
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        alert('No estás autenticado. Por favor, inicia sesión.');
                        return;
                    }

                    // Ocultar la tabla principal y su título
                    gamesTable.style.display = 'none';
                    gamesTitle.style.display = 'none';

                    // Llamada a tu nuevo endpoint de búsqueda en el backend
                    const response = await fetch(`${API_BASE_URL}/api/v1/juegos/buscar?query=${encodeURIComponent(query)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}` // Incluye el token de autenticación
                        }
                    });

                    if (response.ok) {
                        const games = await response.json();
                        displaySearchResults(games); // Mostrar los resultados
                    } else if (response.status === 404) {
                        displaySearchResults([]); // No se encontraron resultados
                    } else {
                        const errorData = await response.json();
                        console.error('Error al buscar juegos:', errorData.detail);
                        alert(`Error al buscar juegos: ${errorData.detail || response.statusText}`);
                        displaySearchResults([]); // Limpiar resultados anteriores en caso de error
                    }
                } catch (error) {
                    console.error('Error de red o inesperado al buscar juegos:', error);
                    alert('Error de conexión o inesperado al buscar juegos. Consulta la consola para más detalles.');
                    displaySearchResults([]); // Limpiar resultados anteriores
                }
            }

            function displaySearchResults(games) {
                // Limpiar el cuerpo de la tabla antes de añadir nuevos resultados
                searchResultsTableBody.innerHTML = ''; 

                // Mostrar u ocultar secciones según los resultados
                searchResultsTitle.style.display = 'block'; // Siempre muestra el título de resultados
                
                if (games.length > 0) {
                    games.forEach(game => {
                        const row = searchResultsTableBody.insertRow();
                        row.insertCell().textContent = game.id;
                        row.insertCell().textContent = game.title;
                        row.insertCell().textContent = game.developer || 'N/A';
                        row.insertCell().textContent = game.publisher || 'N/A';
                        row.insertCell().textContent = game.genres || 'N/A';
                        row.insertCell().textContent = game.release_date || 'N/A';
                        row.insertCell().textContent = game.price !== null ? `$${game.price.toFixed(2)}` : 'N/A';
                        row.insertCell().textContent = game.steam_app_id;
                    });
                    searchResultsTable.style.display = 'table'; // Muestra la tabla de resultados
                    searchNoResults.style.display = 'none';      // Oculta el mensaje de no resultados
                } else {
                    searchResultsTable.style.display = 'none';    // Oculta la tabla
                    searchNoResults.style.display = 'block';      // Muestra el mensaje de no resultados
                }
            }
        });
    </script>
</body>
</html>