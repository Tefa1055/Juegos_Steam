<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Juegos (Prototipo)</title>
    <style>
        body { font-family: sans-serif; background: #222; color: #eee; }
        .container { max-width: 800px; margin: 20px auto; padding: 20px; background: #333; border-radius: 8px; }
        /* Oculta secciones por defecto */
        #auth-section, #dashboard-section { display: none; }
        
        /* Estilos del Wireframe */
        form { display: flex; flex-direction: column; gap: 10px; }
        input { padding: 8px; background: #444; color: #eee; border: 1px solid #555; border-radius: 4px; }
        button { padding: 10px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        
        /* Lista de Juegos */
        #games-list { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .game-card { padding: 15px; background: #444; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .game-card button { background: #dc3545; }
        .game-card button:hover { background: #a71d2a; }
    </style>
</head>
<body>

    <div class="container">

        <section id="auth-section">
            <h1>Bienvenido</h1>
            <p>Por favor, inicia sesión para ver los juegos.</p>
            
            <form id="login-form">
                <h3>Iniciar Sesión</h3>
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Entrar</button>
            </form>
            <p id="login-error" style="color: red;"></p>
            </section>


        <section id="dashboard-section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Tu Dashboard de Juegos</h2>
                <button id="logout-button" style="background: #6c757d;">Cerrar Sesión</button>
            </div>

            <div id="games-list">
                <p>Cargando juegos...</p>
            </div>
        </section>

    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';

        // --- MANEJO DE ESTADO (LOGIN) ---

        // 1. Al cargar la página, revisa si estamos logueados
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginState();
        });

        function checkLoginState() {
            const token = localStorage.getItem('token');
            const authSection = document.getElementById('auth-section');
            const dashboardSection = document.getElementById('dashboard-section');

            if (token) {
                // Si hay token: oculta login, muestra dashboard y carga datos
                authSection.style.display = 'none';
                dashboardSection.style.display = 'block';
                loadDashboardData(token);
            } else {
                // Si NO hay token: muestra login, oculta dashboard
                authSection.style.display = 'block';
                dashboardSection.style.display = 'none';
            }
        }

        // --- MANEJO DE EVENTOS (BOTONES) ---

        // 2. Manejar el formulario de Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';

            // El backend espera 'application/x-www-form-urlencoded' para OAuth2
            const formData = new URLSearchParams();
            formData.append('username', username);
            formData.append('password', password);

            try {
                const response = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error('Usuario o contraseña incorrectos.');
                }

                const data = await response.json();
                localStorage.setItem('token', data.access_token);
                checkLoginState(); // Recarga el estado de la UI

            } catch (error) {
                errorP.textContent = error.message;
            }
        });

        // 3. Manejar el Logout
        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem('token');
            checkLoginState(); // Recarga el estado de la UI
        });


        // --- LÓGICA DEL DASHBOARD (LO QUE PIDE LA PROFE) ---

        async function loadDashboardData(token) {
            const gamesListDiv = document.getElementById('games-list');
            gamesListDiv.innerHTML = '<p>Cargando...</p>';

            try {
                // Paso A: Obtener el ID del usuario actual
                const meResponse = await fetch(`${API_URL}/api/v1/usuarios/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!meResponse.ok) throw new Error('No se pudo verificar el usuario.');
                const currentUser = await meResponse.json(); // { id: 1, username: "..." }

                // Paso B: Obtener la lista de juegos
                const gamesResponse = await fetch(`${API_URL}/api/v1/juegos`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!gamesResponse.ok) throw new Error('No se pudieron cargar los juegos.');
                const games = await gamesResponse.json();

                // Paso C: Dibujar la lista
                gamesListDiv.innerHTML = ''; // Limpiar "Cargando..."
                if (games.length === 0) {
                    gamesListDiv.innerHTML = '<p>No hay juegos para mostrar.</p>';
                    return;
                }

                games.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'game-card';
                    
                    let cardContent = `<span>${game.title} (ID: ${game.id})</span>`;

                    // =========================================================
                    // ¡¡¡AQUÍ ESTÁ LA LÓGICA QUE PIDIÓ LA PROFESORA!!!
                    // Comparamos el ID del usuario logueado (currentUser.id)
                    // con el dueño del juego (game.owner_id)
                    // =========================================================
                    if (currentUser.id === game.owner_id) {
                        cardContent += `
                            <button onclick="handleDeleteGame(${game.id})">
                                Eliminar
                            </button>
                        `;
                    } else {
                        cardContent += `<span>(Solo lectura)</span>`;
                    }
                    
                    card.innerHTML = cardContent;
                    gamesListDiv.appendChild(card);
                });

            } catch (error) {
                gamesListDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
                // Si el token expiró, mejor hacemos logout
                if (error.message.includes('No se pudo verificar')) {
                    localStorage.removeItem('token');
                    checkLoginState();
                }
            }
        }

        async function handleDeleteGame(gameId) {
            if (!confirm(`¿Estás seguro de que quieres eliminar el juego ID ${gameId}?`)) {
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                checkLoginState();
                return;
            }

            try {
                const response = await fetch(`${API_URL}/api/v1/juegos/${gameId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.status === 403) {
                    throw new Error('No tienes permiso para eliminar este juego.');
                }
                if (!response.ok && response.status !== 204) { // 204 es "No Content" (éxito)
                    throw new Error('Error al eliminar el juego.');
                }

                alert('Juego eliminado con éxito.');
                loadDashboardData(token); // Recarga la lista

            } catch (error) {
                alert(error.message);
            }
        }
    </script>
</body>
</html>
